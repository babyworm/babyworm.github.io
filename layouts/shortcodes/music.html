{{- /* Minimal music shortcode
Usage examples:
  {{< music src="/audio/foo.mp3" title="Song" artist="Me" cover="/img/cover.jpg" >}}
  {{< music youtube="https://www.youtube.com/watch?v=dQw4w9WgXcQ" title="Song" >}}
  {{< music spotify="https://open.spotify.com/track/4uLU6hMCjMI75M1A2tKUQC" title="Song" >}}
*/ -}}
{{- $src := .Get "src" -}}
{{- $title := .Get "title" -}}
{{- $artist := .Get "artist" -}}
{{- $cover := .Get "cover" -}}
{{- $autoplay := .Get "autoplay" | default "false" -}}
{{- $loop := .Get "loop" | default "false" -}}
{{- $yt := .Get "youtube" -}}
{{- $sp := .Get "spotify" -}}

<div class="sc-music">
  {{- if $yt -}}
    {{- $id := $yt | replaceRE `^.*(?:v=|youtu\.be/)([A-Za-z0-9_-]{6,}).*$` `${1}` -}}
    <div class="sc-music-embed">
      <iframe
        src="https://www.youtube.com/embed/{{ $id }}"
        title="{{ with $title }}{{ . }}{{ else }}YouTube{{ end }}"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        loading="lazy" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
      </iframe>
    </div>

  {{- else if $sp -}}
    {{- $embed := cond (in $sp "/embed/") $sp (replace $sp "/track/" "/embed/track/") -}}
    <div class="sc-music-embed">
      <iframe
        src="{{ $embed }}"
        title="{{ with $title }}{{ . }}{{ else }}Spotify{{ end }}"
        loading="lazy" referrerpolicy="strict-origin-when-cross-origin"
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture">
      </iframe>
    </div>

  {{- else if $src -}}
    <div class="sc-music-audio">
      {{- with $cover -}}<img class="sc-music-cover" src="{{ . }}" alt="cover">{{- end -}}
      <div class="sc-music-meta">
        {{- if or $title $artist -}}
          <div class="sc-music-title">
            {{- with $title -}}<strong>{{ . }}</strong>{{- end -}}
            {{- if and $title $artist -}} Â· {{- end -}}
            {{- with $artist -}}<span class="sc-music-artist">{{ . }}</span>{{- end -}}
          </div>
        {{- end -}}
        <audio controls {{ if eq (lower $autoplay) "true" }}autoplay{{ end }} {{ if eq (lower $loop) "true" }}loop{{ end }}>
          <source src="{{ $src }}">
          Your browser does not support the audio element.
        </audio>
      </div>
    </div>

  {{- else -}}
    <div class="notice notice-warning">
      <div class="notice-title">Music</div>
      <div class="notice-body">
        Missing <code>src</code>, <code>youtube</code>, or <code>spotify</code> parameter.
      </div>
    </div>
  {{- end -}}
</div>


