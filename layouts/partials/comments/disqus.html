{{/* Override: auto-load Disqus without click (configurable) */}}
{{ $auto := .Site.Params.disqus.autoLoad | default true }}
{{ $allowLocal := .Site.Params.disqus.allowLocal | default false }}

<div class="disqus-comment">
  {{ if not $auto }}
    <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
      {{ i18n "loadDisqus" }}
    </div>
  {{ else }}
    <div class="disqus-button" id="load_disqus" style="display:none" onclick="load_disqus()">
      {{ i18n "loadDisqus" }}
    </div>
  {{ end }}
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = {{ .Permalink | jsonify }};
      this.page.identifier = {{ with .File }}{{ .UniqueID | jsonify }}{{ else }}{{ .RelPermalink | jsonify }}{{ end }};
    };
    function load_disqus() {
      // Guard on localhost unless explicitly allowed
      if (window.location.hostname === 'localhost' && {{ if $allowLocal }}false{{ else }}true{{ end }}) return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = {{ .Site.DisqusShortname | jsonify }};
      //dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.head || document.body).appendChild(dsq);

      var btn = document.getElementById('load_disqus');
      if (btn) btn.remove();
    }
    {{ if $auto }}
    (function(){
      function tryAutoLoad(){
        try { load_disqus(); } catch (e) {}
        // Fallback: if DISQUS object not present after 5s, reveal manual button
        setTimeout(function(){
          if (!window.DISQUS) {
            var btn = document.getElementById('load_disqus');
            if (btn) btn.style.display = '';
          }
        }, 5000);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryAutoLoad);
      } else {
        tryAutoLoad();
      }
    })();
    {{ end }}
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow noopener" target="_blank">comments powered by Disqus.</a>
  </noscript>
</div>
